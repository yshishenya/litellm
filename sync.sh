#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤–∞—à–µ–≥–æ —Ñ–æ—Ä–∫–∞ —Å upstream

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å upstream (BerriAI/litellm)..."
echo ""

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
CURRENT_BRANCH=$(git branch --show-current)
echo "üìç –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
if ! git diff-index --quiet HEAD --; then
    echo "‚ö†Ô∏è  –£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!"
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–ª–∏ stash –∏—Ö –ø–µ—Ä–µ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π."
    exit 1
fi

# –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ main
echo "üì¶ –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ main..."
git checkout main

# –°—Ç—è–Ω—É—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ upstream
echo "‚¨áÔ∏è  –ó–∞–≥—Ä—É–∂–∞—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ upstream..."
git fetch upstream

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–∫–æ–ª—å–∫–æ –∫–æ–º–º–∏—Ç–æ–≤ –æ—Ç—Å—Ç–∞–µ–º
BEHIND=$(git rev-list --count HEAD..upstream/main)
echo "üìä –í–∞—à main –æ—Ç—Å—Ç–∞–µ—Ç –Ω–∞ $BEHIND –∫–æ–º–º–∏—Ç–æ–≤"

if [ "$BEHIND" -eq 0 ]; then
    echo "‚úÖ –í–∞—à main —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω!"
else
    # –°–ª–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    echo "üîÄ –°–ª–∏–≤–∞—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ upstream/main..."
    git merge upstream/main --no-edit

    # –ó–∞–ø—É—à–∏—Ç—å –≤ origin
    echo "‚¨ÜÔ∏è  –ü—É—à—É –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π main –≤ origin..."
    git push origin main

    echo "‚úÖ Main —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!"
fi

# –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –∏—Å—Ö–æ–¥–Ω—É—é –≤–µ—Ç–∫—É
if [ "$CURRENT_BRANCH" != "main" ]; then
    echo "‚Ü©Ô∏è  –í–æ–∑–≤—Ä–∞—â–∞—é—Å—å –Ω–∞ –≤–µ—Ç–∫—É $CURRENT_BRANCH..."
    git checkout "$CURRENT_BRANCH"

    echo ""
    echo "üí° –°–æ–≤–µ—Ç: –û–±–Ω–æ–≤–∏—Ç–µ –≤–∞—à—É feature –≤–µ—Ç–∫—É:"
    echo "   git merge main"
    echo "   –∏–ª–∏"
    echo "   git rebase main"
fi

echo ""
echo "üéâ –ì–æ—Ç–æ–≤–æ!"
