# LiteLLM Migration Rollback Plan

## План отката миграции в случае критических проблем

**ВАЖНО:** Этот документ описывает процедуру экстренного возврата к старому серверу в случае критических проблем после миграции.

---

## Когда использовать откат

### Критические ситуации (немедленный откат):
- ❌ API не отвечает на запросы более 15 минут после миграции
- ❌ PostgreSQL база данных недоступна или повреждена
- ❌ Потеря данных обнаружена (несоответствие количества записей)
- ❌ Критические ошибки в логах, приводящие к сбоям
- ❌ Невозможность восстановить работу сервисов на новом сервере
- ❌ Серьезные проблемы с производительностью (10x+ медленнее)

### Некритические ситуации (откат опционален):
- ⚠️ Предупреждения в логах (но система работает)
- ⚠️ Минорные проблемы с метриками
- ⚠️ Grafana дашборды не отображают старые данные (но новые работают)
- ⚠️ Отдельные функции не работают, но основной API функционален

---

## Сценарии отката

### Сценарий 1: Откат до переключения DNS (простой)

**Ситуация:** Проблемы обнаружены на новом сервере ДО переключения DNS.

**Действия:**
1. Не переключать DNS
2. Оставить старый сервер работающим
3. Устранить проблемы на новом сервере
4. Повторить миграцию после исправления

**Время на откат:** 0 минут (DNS не трогали)

---

### Сценарий 2: Откат СРАЗУ после переключения DNS (быстрый)

**Ситуация:** Проблемы обнаружены в первые 5-30 минут после переключения DNS.

**Время на откат:** 5-10 минут

#### Шаг 1: Переключить DNS обратно

```bash
# 1. Войти в панель управления DNS
# 2. Изменить A-записи обратно:
#    litellm.pro-4.ru → [IP старого сервера]
#    dash.pro-4.ru → [IP старого сервера]
# 3. Сохранить с минимальным TTL (300 секунд)
```

#### Шаг 2: Проверить старый сервер

**На старом сервере:**

```bash
# Подключиться к старому серверу
ssh [старый_сервер]
cd /home/yan/litellm

# Проверить статус контейнеров
docker ps

# Если контейнеры остановлены, запустить
docker compose up -d

# Проверить здоровье
docker compose ps
curl http://localhost:4000/health/liveliness

# Проверить логи
docker compose logs --tail=50
```

#### Шаг 3: Проверить доступность

```bash
# Проверить PostgreSQL
PGPASSWORD=dbpassword9090 psql -h localhost -p 5433 -U llmproxy -d litellm \
  -c "SELECT COUNT(*) FROM \"LiteLLM_SpendLogs\""

# Проверить API
curl http://localhost:4000/health/liveliness
curl http://localhost:4000/v1/models

# Проверить Grafana
curl http://localhost:3098/api/health
```

#### Шаг 4: Дождаться распространения DNS

```bash
# Проверить DNS
nslookup litellm.pro-4.ru
nslookup dash.pro-4.ru

# Проверить с внешних DNS
nslookup litellm.pro-4.ru 8.8.8.8
nslookup litellm.pro-4.ru 1.1.1.1

# Использовать онлайн проверку
# https://www.whatsmydns.net/
```

#### Шаг 5: Уведомить пользователей

```bash
# Отправить уведомление в Telegram
./scripts/telegram-notify.sh "⚠️ Откат миграции выполнен. Сервис работает на старом сервере."
```

**Статус:** Откат завершен, система работает на старом сервере.

---

### Сценарий 3: Откат через несколько часов (с потерей новых данных)

**Ситуация:** Проблемы обнаружены через несколько часов после переключения DNS. Новый сервер принимал запросы.

**Время на откат:** 15-30 минут

**ВАЖНО:** Возможна потеря данных, созданных на новом сервере после переключения!

#### Шаг 1: Оценить потери данных

**На новом сервере:**

```bash
ssh yan@65.21.202.252
cd /home/yan/litellm

# Проверить количество новых записей после миграции
PGPASSWORD=dbpassword9090 psql -h localhost -p 5433 -U llmproxy -d litellm -c "
  SELECT COUNT(*) as new_records
  FROM \"LiteLLM_SpendLogs\"
  WHERE created_at > '[время_миграции]'
"

# Создать бэкап текущего состояния
./scripts/backup.sh
```

#### Шаг 2: Экспорт новых данных (если критичны)

```bash
# Экспортировать новые данные
PGPASSWORD=dbpassword9090 pg_dump -h localhost -p 5433 -U llmproxy -d litellm \
  --data-only \
  --table="LiteLLM_SpendLogs" \
  --table="LiteLLM_UserTable" \
  > /tmp/new_data_dump.sql

# Скопировать на старый сервер
scp /tmp/new_data_dump.sql [старый_сервер]:/tmp/
```

#### Шаг 3: Переключить DNS обратно

```bash
# 1. Войти в панель управления DNS
# 2. Изменить A-записи обратно на старый сервер
# 3. Сохранить
```

#### Шаг 4: Запустить старый сервер

**На старом сервере:**

```bash
# Запустить контейнеры
docker compose up -d

# Проверить здоровье
docker compose ps
./scripts/post-migration-verify.sh
```

#### Шаг 5: Импортировать новые данные (опционально)

**ВНИМАНИЕ:** Только если новые данные критичны!

```bash
# На старом сервере
PGPASSWORD=dbpassword9090 psql -h localhost -p 5433 -U llmproxy -d litellm \
  < /tmp/new_data_dump.sql

# Проверить конфликты и дубликаты
PGPASSWORD=dbpassword9090 psql -h localhost -p 5433 -U llmproxy -d litellm -c "
  SELECT id, COUNT(*)
  FROM \"LiteLLM_SpendLogs\"
  GROUP BY id
  HAVING COUNT(*) > 1
"
```

**Статус:** Откат завершен. Возможна частичная потеря данных.

---

### Сценарий 4: Откат через 24+ часов (сложный)

**Ситуация:** Проблемы обнаружены через 24+ часов. Много новых данных на новом сервере.

**Время на откат:** 30-60 минут

**КРИТИЧНО:** Значительная потеря данных неизбежна!

#### Решение 1: Синхронизация данных

**Рекомендуется только если:**
- Старый сервер НЕ принимал запросы
- Все новые данные только на новом сервере
- Есть время на полную синхронизацию

**Шаги:**

```bash
# 1. Создать полный бэкап нового сервера
ssh yan@65.21.202.252 "cd /home/yan/litellm && ./scripts/backup.sh"

# 2. Скопировать бэкап на старый сервер
rsync -avz yan@65.21.202.252:/home/yan/litellm/backups/latest/ \
  /tmp/new_server_backup/

# 3. Остановить новый сервер
ssh yan@65.21.202.252 "cd /home/yan/litellm && docker compose down"

# 4. Восстановить на старом сервере
cd /home/yan/litellm
./scripts/restore.sh /tmp/new_server_backup

# 5. Запустить старый сервер
docker compose up -d

# 6. Переключить DNS обратно
```

#### Решение 2: Принять потерю данных

**Если синхронизация невозможна:**

```bash
# 1. Переключить DNS на старый сервер
# 2. Запустить старый сервер с последним бэкапом
# 3. Уведомить пользователей о потере данных за период
# 4. Вручную восстановить критичные данные из логов/экспортов
```

**Статус:** Откат с потерей данных.

---

## Автоматический скрипт отката

### Быстрый откат (для сценариев 1-2)

Создайте скрипт `/home/yan/litellm/scripts/emergency-rollback.sh`:

```bash
#!/bin/bash

# Emergency Rollback Script

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${RED}═══════════════════════════════════════════${NC}"
echo -e "${RED}  EMERGENCY ROLLBACK TO OLD SERVER${NC}"
echo -e "${RED}═══════════════════════════════════════════${NC}"
echo ""

read -p "Вы уверены? Это вернет систему на старый сервер. (yes/no): " confirm
if [[ ! "$confirm" =~ ^[Yy][Ee][Ss]$ ]]; then
    echo "Отмена отката"
    exit 1
fi

echo -e "${YELLOW}[1/5] Проверка статуса контейнеров...${NC}"
docker compose ps

echo -e "${YELLOW}[2/5] Запуск всех контейнеров...${NC}"
docker compose up -d

sleep 10

echo -e "${YELLOW}[3/5] Проверка здоровья сервисов...${NC}"
curl -sf http://localhost:4000/health/liveliness && echo "✓ LiteLLM OK" || echo "✗ LiteLLM FAIL"
curl -sf http://localhost:3098/api/health && echo "✓ Grafana OK" || echo "✗ Grafana FAIL"

PGPASSWORD=dbpassword9090 psql -h localhost -p 5433 -U llmproxy -d litellm -c "SELECT 1" &>/dev/null \
  && echo "✓ PostgreSQL OK" || echo "✗ PostgreSQL FAIL"

echo -e "${YELLOW}[4/5] Отправка уведомления...${NC}"
./scripts/telegram-notify.sh "⚠️ ОТКАТ: Система вернулась на старый сервер"

echo ""
echo -e "${GREEN}═══════════════════════════════════════════${NC}"
echo -e "${GREEN}  ОТКАТ НА СТАРЫЙ СЕРВЕР ЗАВЕРШЕН${NC}"
echo -e "${GREEN}═══════════════════════════════════════════${NC}"
echo ""
echo -e "${YELLOW}СЛЕДУЮЩИЕ ШАГИ:${NC}"
echo "1. Переключите DNS обратно на старый сервер вручную"
echo "2. Дождитесь распространения DNS (5-15 минут)"
echo "3. Проверьте доступность через домены"
echo "4. Проанализируйте причины проблем на новом сервере"
echo ""
```

Сделайте скрипт исполняемым:

```bash
chmod +x scripts/emergency-rollback.sh
```

**Использование:**

```bash
cd /home/yan/litellm
./scripts/emergency-rollback.sh
```

---

## Чек-лист отката

### Перед откатом:

- [ ] Оценить серьезность проблемы
- [ ] Определить, действительно ли нужен откат
- [ ] Записать все симптомы и ошибки
- [ ] Сделать снимок состояния нового сервера
- [ ] Оценить возможные потери данных
- [ ] Уведомить заинтересованных лиц

### Во время отката:

- [ ] Записать время начала отката
- [ ] Переключить DNS на старый сервер
- [ ] Запустить/проверить контейнеры на старом сервере
- [ ] Проверить работоспособность всех сервисов
- [ ] Дождаться распространения DNS
- [ ] Проверить доступность через домены

### После отката:

- [ ] Записать время завершения отката
- [ ] Уведомить пользователей о восстановлении
- [ ] Задокументировать причины отката
- [ ] Создать post-mortem анализ
- [ ] Сохранить логи с нового сервера для анализа
- [ ] Исправить проблемы перед повторной миграцией

---

## Команды для экстренных ситуаций

### На старом сервере:

```bash
# Быстрый запуск
docker compose up -d

# Проверка статуса
docker compose ps

# Проверка логов на ошибки
docker compose logs --tail=100 | grep -i error

# Перезапуск отдельного сервиса
docker compose restart litellm

# Полный рестарт
docker compose down && docker compose up -d

# Проверка здоровья PostgreSQL
PGPASSWORD=dbpassword9090 psql -h localhost -p 5433 -U llmproxy -d litellm -c "\dt"

# Проверка API
curl -v http://localhost:4000/health/liveliness
```

### Восстановление из бэкапа:

```bash
# Список доступных бэкапов
ls -lh /home/yan/litellm/backups/

# Восстановление из последнего бэкапа
cd /home/yan/litellm
./scripts/restore.sh backups/latest

# Восстановление из конкретного бэкапа
./scripts/restore.sh backups/weekly/2025-W44
```

### Проверка DNS:

```bash
# Локальная проверка
nslookup litellm.pro-4.ru
nslookup dash.pro-4.ru

# Проверка с разных DNS
dig @8.8.8.8 litellm.pro-4.ru
dig @1.1.1.1 litellm.pro-4.ru
dig @8.8.4.4 dash.pro-4.ru

# Проверка времени распространения
watch -n 5 'nslookup litellm.pro-4.ru'
```

---

## Анализ после отката

### Что анализировать:

1. **Логи с нового сервера:**
   ```bash
   # Скопировать логи для анализа
   ssh yan@65.21.202.252 "cd /home/yan/litellm && docker compose logs" > new_server_logs.txt
   ```

2. **Состояние базы данных:**
   ```bash
   # Экспорт схемы для сравнения
   ssh yan@65.21.202.252 "PGPASSWORD=dbpassword9090 pg_dump -h localhost -p 5433 -U llmproxy -d litellm --schema-only" > new_server_schema.sql
   ```

3. **Метрики производительности:**
   ```bash
   # Экспорт метрик из Prometheus
   ssh yan@65.21.202.252 "curl http://localhost:9092/api/v1/query?query=up" > new_server_metrics.json
   ```

4. **Конфигурация:**
   ```bash
   # Сравнить конфигурацию
   diff <(ssh old_server "cat /home/yan/litellm/.env") \
        <(ssh 65.21.202.252 "cat /home/yan/litellm/.env")
   ```

### Вопросы для post-mortem:

- Что пошло не так?
- Почему это не было обнаружено при тестировании?
- Какие сигналы мы пропустили?
- Как быстро мы обнаружили проблему?
- Насколько эффективен был откат?
- Какие данные были потеряны?
- Как предотвратить это в будущем?

---

## Предотвращение необходимости отката

### Перед миграцией:

- ✅ Тщательное тестирование на новом сервере
- ✅ Запуск всех проверочных скриптов
- ✅ Проверка совместимости версий
- ✅ Тестирование восстановления из бэкапа
- ✅ Smoke tests всех критичных функций

### Во время миграции:

- ✅ Следование чек-листу миграции
- ✅ Постепенное переключение (не резко)
- ✅ Мониторинг в реальном времени
- ✅ Готовый план отката
- ✅ Команда на связи

### После миграции:

- ✅ Интенсивный мониторинг первые 24 часа
- ✅ Сохранение старого сервера 48+ часов
- ✅ Автоматические алерты на аномалии
- ✅ Регулярные проверки здоровья

---

## Контакты для экстренных ситуаций

**Telegram уведомления:**
```bash
./scripts/telegram-notify.sh "ЭКСТРЕННОЕ СООБЩЕНИЕ"
```

**Важные команды:**
```bash
# Проверка всего
./scripts/post-migration-verify.sh

# Экстренный откат
./scripts/emergency-rollback.sh

# Создание бэкапа
./scripts/backup.sh

# Восстановление
./scripts/restore.sh
```

---

## Заключение

**Помните:**
- Откат - это не провал, это план Б
- Лучше откатиться быстро, чем мучиться с проблемами
- Старый сервер - ваша страховка, не удаляйте его рано
- Всегда анализируйте причины после отката
- Используйте опыт для улучшения процесса

**Золотое правило:**
> "Если сомневаетесь - откатывайтесь. Безопасность данных важнее престижа."

---

*Этот план должен быть легко доступен во время миграции. Распечатайте или держите открытым в браузере.*
